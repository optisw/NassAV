<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NassAV</title>
  <style>
    :root { --bg:#0b1220; --card:#121b2f; --text:#e8eefc; --muted:#9bb0d1; --accent:#306DF1; --danger:#ff5a7a; }
    body{margin:0;background:linear-gradient(180deg,#060b16,#0b1220);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:760px;margin:40px auto;padding:0 16px}
    .card{background:rgba(18,27,47,.9);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35);padding:18px}
    h1{font-size:20px;margin:0 0 12px 0;letter-spacing:.5px}

    .row{display:flex;gap:10px;align-items:flex-start}

    /* 输入框：默认高度≈按钮高度，自动随行数增高 */
    textarea{
      flex:1;
      min-width:260px;
      height:40px;                /* ✅ 默认高度=按钮高度 */
      max-height:220px;           /* ✅ 增高到上限后内部滚动 */
      resize:none;
      overflow:auto;

      background:#0a1225;border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:9px 12px;
      border-radius:10px;
      outline:none;
      line-height:1.4;
      box-sizing:border-box;

      /* ✅ 隐藏滚动条（仍可滚动） */
      scrollbar-width:none;       /* Firefox */
      -ms-overflow-style:none;    /* IE/Edge(old) */
    }
    textarea::-webkit-scrollbar{  /* Chrome/Safari */
      width:0;height:0;
    }

    /* 下载按钮：正方形、#306DF1、白字、无圆角 */
    button{
      width:40px;height:40px;     /* ✅ 方形 */
      background:var(--accent);
      border:none;
      color:#ffffff;
      padding:0;
      border-radius:0;            /* ✅ 无圆角 */
      cursor:pointer;
      font-weight:700;
    }
    button:disabled{opacity:.6;cursor:not-allowed}

    .bar{height:12px;background:#0a1225;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.12)}
    .bar > div{height:100%;width:0%;background:linear-gradient(90deg,#306DF1,#7cf6ff);transition:width .25s ease}

    .meta{
      display:flex;
      justify-content:space-between;
      gap:8px;
      color:var(--muted);
      font-size:12px;
      margin-top:8px
    }
    .danger{color:var(--danger)}

    /* ✅ 固定高度日志：只滚内容，不撑页面；隐藏右侧滚动条 */
    .logwrap{
      margin-top:10px;
      background:#0a1225;border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px 12px;
    }
    .log{
      height:220px;
      overflow-y:auto;
      white-space:pre-wrap;
      color:var(--muted);
      font-size:12px;

      scrollbar-width:none;
      -ms-overflow-style:none;
    }
    .log::-webkit-scrollbar{
      width:0;height:0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>NassAV</h1>

      <div class="row">
        <textarea id="plate" placeholder="例如：XXX-001"></textarea>
        <button id="btnStart">下载</button>
      </div>

      <div style="height:12px"></div>
      <div class="bar"><div id="barFill"></div></div>

      <div class="meta">
        <div id="percent">0%</div>
        <!-- ✅ 右下角：车牌号 | 状态... -->
        <div id="status">就绪</div>
      </div>

      <div class="logwrap">
        <div class="log" id="log">等待操作…</div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);

  let esProgress = null;
  let esLog = null;

  let queue = [];
  let currentIndex = 0;
  let running = false;

  const MAX_LOG_CHARS = 50000;

  function setProgress(p){
    p = Math.max(0, Math.min(100, p||0));
    $("barFill").style.width = p + "%";
    $("percent").innerText = p + "%";
  }

  function statusTextFrom(status){
    if(status === "done") return "已下载...";
    if(status === "error") return "失败...";
    return "下载中...";
  }

  function setStatusWithPlate(plate, status, danger=false){
    const left = (plate && plate.trim()) ? plate.trim().toUpperCase() + " | " : "";
    $("status").innerText = left + statusTextFrom(status);
    $("status").className = danger ? "danger" : "";
  }

  function resetLog(){
    $("log").innerText = "等待操作…";
    $("log").scrollTop = 0;
  }

  function appendLogLine(line){
    let cur = $("log").innerText || "";
    if(cur === "等待操作…") cur = "";
    cur += (line + "\n");
    if(cur.length > MAX_LOG_CHARS){
      cur = cur.slice(cur.length - MAX_LOG_CHARS);
    }
    $("log").innerText = cur;
    $("log").scrollTop = $("log").scrollHeight;
  }

  function closeStreams(){
    if(esProgress){ try{ esProgress.close(); }catch(e){} esProgress = null; }
    if(esLog){ try{ esLog.close(); }catch(e){} esLog = null; }
  }

  function parsePlates(){
    const raw = $("plate").value || "";
    const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const x of lines){
      const p = x.toUpperCase();
      if(!seen.has(p)){ seen.add(p); out.push(p); }
    }
    return out;
  }

  async function startQueue(){
    if(running) return;

    queue = parsePlates();
    if(queue.length === 0){
      setStatusWithPlate("", "error", true);
      resetLog();
      return;
    }

    running = true;
    currentIndex = 0;
    $("btnStart").disabled = true;

    setProgress(0);
    setStatusWithPlate(queue[0], "running", false);
    resetLog();

    await runNext();
  }

  async function runNext(){
    closeStreams();

    if(currentIndex >= queue.length){
      // 全部完成
      running = false;
      $("btnStart").disabled = false;
      setProgress(100);
      setStatusWithPlate("", "done", false);
      resetLog(); // ✅ 全部完成清空日志
      return;
    }

    const plate = queue[currentIndex];
    setProgress(0);
    setStatusWithPlate(plate, "running", false);
    resetLog();

    // 提交任务
    const fd = new FormData();
    fd.append("plate", plate);

    const res = await fetch("/api/start", { method:"POST", body: fd });
    if(!res.ok){
      setStatusWithPlate(plate, "error", true);
      appendLogLine(await res.text());
      running = false;
      $("btnStart").disabled = false;
      return;
    }

    const data = await res.json();
    const taskId = data.task_id;

    // 订阅进度
    esProgress = new EventSource(`/api/progress/${taskId}/stream`);
    esProgress.onmessage = async (evt)=>{
      const d = JSON.parse(evt.data);
      setProgress(d.percent || 0);

      // ✅ 右下角显示：车牌号 | 状态...
      setStatusWithPlate(plate, d.status, d.status === "error");

      if(d.status === "done"){
        closeStreams();
        resetLog();           // ✅ 单个下载完成就清空日志
        currentIndex += 1;
        await runNext();
      }
      if(d.status === "error"){
        closeStreams();
        setStatusWithPlate(plate, "error", true);
        // 失败后也清空回初始（你之前的“完成后清空”逻辑，我保持一致）
        setTimeout(()=>resetLog(), 200);
        running = false;
        $("btnStart").disabled = false;
      }
    };

    // 订阅日志（逐行追加）
    esLog = new EventSource(`/api/logs/${taskId}/stream`);
    esLog.onmessage = (evt)=>{
      const item = JSON.parse(evt.data); // {seq, line}
      appendLogLine(item.line);
    };
  }

  // ✅ 输入框随内容自动增高
  function autoResize(){
    const ta = $("plate");
    ta.style.height = "40px"; // 回到初始高度再测
    const newH = Math.min(220, ta.scrollHeight);
    ta.style.height = newH + "px";
  }

  $("btnStart").addEventListener("click", startQueue);
  $("plate").addEventListener("input", autoResize);
  window.addEventListener("load", autoResize);
</script>

</body>
</html>
